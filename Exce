package com.rbs.bdd.application.service;


import com.rbs.bdd.application.exception.SchemaValidationException;
import com.rbs.bdd.application.port.out.AccountValidationPort;
import com.rbs.bdd.generated.*;
import com.rbs.bdd.infrastructure.soap.model.Envelope;
import jakarta.xml.bind.JAXBContext;
import jakarta.xml.bind.JAXBElement;
import jakarta.xml.bind.Marshaller;
import jakarta.xml.bind.Unmarshaller;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;


import javax.xml.transform.Source;
import javax.xml.transform.stream.StreamSource;
import java.io.ByteArrayInputStream;
import java.io.ByteArrayOutputStream;
import java.io.FileNotFoundException;
import java.io.InputStream;
import java.lang.Exception;

@Service
@RequiredArgsConstructor
public class AccountValidationService implements AccountValidationPort {

    @Override
    public void validateSchema(ValidateArrangementForPaymentRequest request) {
        // Schema is validated automatically by Spring WS
        System.out.println("Schema Validation ");
    }


    /** Working
    @Override
    public ValidateArrangementForPaymentResponse validateBusinessRules(ValidateArrangementForPaymentRequest request) {
        try {
            System.out.println("Process started for business logic");

            // Create JAXB context for the envelope wrapper class
            JAXBContext context = JAXBContext.newInstance(Envelope.class);
            Unmarshaller unmarshaller = context.createUnmarshaller();

            // Load the static SOAP response
            InputStream xml = getClass().getClassLoader().getResourceAsStream("static-response/response1.xml");
            if (xml == null) {
                throw new FileNotFoundException("File static-response/response1.xml not found.");
            }

            // Unmarshal the full SOAP envelope
            Envelope envelope = (Envelope) unmarshaller.unmarshal(xml);
            if(envelope==null || envelope.getBody()==null)
            {
                throw new SchemaValidationException("SOAP envelope or body is null");

            }
            ValidateArrangementForPaymentResponse response = envelope.getBody().getValidateArrangementForPaymentResponse();

            if(response==null)
            {
                throw new SchemaValidationException("SOAP envelope or body is null");

            }
            ValidateArrangementForPaymentContent content=response.getResponse();
            if(content ==null)
            {
                throw new SchemaValidationException("SOAP envelope or body is null");

            }
            ResponseHeader header= content.getResponseHeader();

            // Business logic
            String operatingBrand = request.getRequestHeader().getOperatingBrand();
            if ("ALL".equalsIgnoreCase(operatingBrand)) {
                ProcessingIdentifier responseId= header.getResponseId();
                if(responseId==null)
                {
                   responseId= new ProcessingIdentifier();
                   header.setResponseId(responseId);

                }
                responseId.setSystemId("ModifiedESP");
                responseId.setTransactionId("ModifiedTxn123");

            }

            return response;
        } catch (Exception e) {
            throw new SchemaValidationException("Failed to process static response XML", e);
        }
    }
    **/
//    @Override
//    public Source validateBusinessRules(ValidateArrangementForPaymentRequest request) {
//        try {
//            JAXBContext context = JAXBContext.newInstance(Envelope.class);
//            Unmarshaller unmarshaller = context.createUnmarshaller();
//            Marshaller marshaller = context.createMarshaller();
//
//            InputStream xml = getClass().getClassLoader().getResourceAsStream("static-response/response1.xml");
//            Envelope envelope = (Envelope) unmarshaller.unmarshal(xml);
//
//            // Modify response
//            ValidateArrangementForPaymentResponse response = envelope.getBody().getValidateArrangementForPaymentResponse();
//            String brand = request.getRequestHeader().getOperatingBrand();
//            if ("ALL".equalsIgnoreCase(brand)) {
//                ResponseHeader header = response.getResponse().getResponseHeader();
//                ProcessingIdentifier id = header.getResponseId();
//                if (id == null) id = new ProcessingIdentifier();
//                id.setSystemId("ModifiedESP");
//                id.setTransactionId("ModifiedTxn123");
//                header.setResponseId(id);
//            }
//
//            // Marshal back to byte array and return as Source
//            ByteArrayOutputStream output = new ByteArrayOutputStream();
//            marshaller.marshal(envelope, output);
//            ByteArrayInputStream input = new ByteArrayInputStream(output.toByteArray());
//            return new StreamSource(input);
//
//        } catch (Exception e) {
//            throw new SchemaValidationException("Unable to process SOAP response", e);
//        }
//    }

    @Override
    public Source validateBusinessRules(ValidateArrangementForPaymentRequest request) {
        try {
            // Load and unmarshal full SOAP response envelope
            JAXBContext context = JAXBContext.newInstance(Envelope.class);
            Unmarshaller unmarshaller = context.createUnmarshaller();
            InputStream xml = getClass().getClassLoader().getResourceAsStream("static-response/response.xml");

            Envelope envelope = (Envelope) unmarshaller.unmarshal(xml);




            if(envelope==null || envelope.getBody()==null)
            {
                throw new SchemaValidationException("SOAP envelope or body is null");

            }

            // Modify fields if needed
            ValidateArrangementForPaymentResponse response =
                    envelope.getBody().getValidateArrangementForPaymentResponse();
            if(response==null)
            {
                throw new SchemaValidationException("SOAP envelope or body is null");

            }

            ResponseHeader header = response.getResponse().getResponseHeader();
            String brand = request.getRequestHeader().getOperatingBrand();

            if ("ALL".equalsIgnoreCase(brand)) {
                ProcessingIdentifier id = header.getResponseId();
                if (id == null) id = new ProcessingIdentifier();
                id.setSystemId("ModifiedESP");
                id.setTransactionId("ModifiedTxn123");
                header.setResponseId(id);
            }

            // Marshal back to Source to preserve full static SOAP structure
            Marshaller marshaller = context.createMarshaller();
            ByteArrayOutputStream output = new ByteArrayOutputStream();
            marshaller.marshal(envelope, output);
            return new StreamSource(new ByteArrayInputStream(output.toByteArray()));

        } catch (Exception e) {
            throw new RuntimeException("Failed to process response", e);
        }
    }
}
